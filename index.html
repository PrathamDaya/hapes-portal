<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hapes Portal - Remastered</title>
    <style>
        /* ===== VARIABLES & THEME ===== */
        :root {
            --bg-primary: linear-gradient(135deg, #fceaff 0%, #fff0f5 100%);
            --bg-secondary: rgba(255, 255, 255, 0.9);
            --text-primary: #5c3b4c;
            --accent-color: #d94a6b;
            --accent-gradient: linear-gradient(45deg, #ff80a0, #d94a6b);
            --card-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            --border-color: #ffe0f0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        /* ===== LAYOUT & CONTAINERS ===== */
        #appContainer { max-width: 800px; width: 100%; }
        
        .screen { display: none; animation: fadeIn 0.4s ease; }
        .screen.active { display: block; }
        
        .container {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        button {
            background: var(--accent-gradient);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }
        button:hover { transform: scale(1.05); }

        /* ===== DIARY SPECIFIC STYLES ===== */
        .diary-entry-list-item {
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .entry-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #888;
        }

        .entry-content { font-size: 1.1em; margin-bottom: 15px; line-height: 1.5; }

        /* Reply Section Styling */
        .reply-section {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 3px solid var(--accent-color);
        }
        
        .reply-btn { background: #6c757d; font-size: 0.8em; padding: 5px 15px; }
        
        /* ===== GAME CANVAS STYLES ===== */
        .game-canvas-container {
            position: relative;
            width: 100%;
            height: 500px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid var(--accent-color);
            touch-action: none; /* Prevent scrolling while playing */
        }

        canvas { width: 100%; height: 100%; display: block; }

        .game-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .score-board { font-size: 1.5em; font-weight: bold; color: var(--accent-color); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="appContainer">
    <section id="homeScreen" class="screen active">
        <div class="container" style="text-align: center;">
            <h1>Hapes Portal</h1>
            <p style="margin: 20px 0; color: #888;">Select an activity</p>
            <div style="display: grid; gap: 15px; grid-template-columns: 1fr 1fr;">
                <button onclick="nav('diaryScreen')">üìñ Diary Portal</button>
                <button onclick="nav('slasherScreen')">üçâ Love Slasher (3D)</button>
                <button onclick="nav('catchScreen')">üíñ Catch Heart (3D)</button>
            </div>
        </div>
    </section>

    <section id="diaryScreen" class="screen">
        <div class="container">
            <header>
                <button onclick="nav('homeScreen')">üè† Home</button>
                <h2>Diary Entries</h2>
            </header>
            <div id="diaryList">
                </div>
            <div style="margin-top:20px; text-align: center;">
                <button onclick="addMockEntry()">+ Add Test Entry</button>
            </div>
        </div>
    </section>

    <section id="slasherScreen" class="screen">
        <div class="container">
            <header>
                <button onclick="stopGames(); nav('homeScreen')">‚ùå Exit</button>
                <div class="score-board">Score: <span id="slashScore">0</span></div>
            </header>
            <div class="game-canvas-container" id="slasherContainer">
                <canvas id="slasherCanvas"></canvas>
                <div id="slasherOverlay" class="game-overlay">
                    <h2>Love Slasher 3D</h2>
                    <p>Swipe to slice fruits. Avoid the Bomb!</p>
                    <br>
                    <button onclick="initSlasher()">Start Game</button>
                </div>
            </div>
        </div>
    </section>

    <section id="catchScreen" class="screen">
        <div class="container">
            <header>
                <button onclick="stopGames(); nav('homeScreen')">‚ùå Exit</button>
                <div class="score-board">Score: <span id="catchScore">0</span></div>
            </header>
            <div class="game-canvas-container" id="catchContainer">
                <canvas id="catchCanvas"></canvas>
                <div id="catchOverlay" class="game-overlay">
                    <h2>Catch The Heart 3D</h2>
                    <p>Move basket to catch shiny hearts!</p>
                    <br>
                    <button onclick="initCatchGame()">Start Game</button>
                </div>
            </div>
        </div>
    </section>
</div>

<script>
    // ===== NAVIGATION & UTILS =====
    let currentGameLoop = null;

    function nav(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        if(screenId === 'diaryScreen') renderDiary();
    }

    function stopGames() {
        if (currentGameLoop) cancelAnimationFrame(currentGameLoop);
        currentGameLoop = null;
    }

    // ===== DIARY COMPONENT (Fixed Logic) =====
    // Mock Data for demonstration - in production this comes from Google Script
    let diaryData = JSON.parse(localStorage.getItem('hapesDiary')) || [
        { id: 1, date: '2025-07-20', author: 'Chikoo', text: 'I really missed you today. The weather was rainy and it reminded me of our first date.', replies: [] }
    ];

    function saveDiary() { localStorage.setItem('hapesDiary', JSON.stringify(diaryData)); }

    function addMockEntry() {
        diaryData.push({
            id: Date.now(),
            date: new Date().toISOString().split('T')[0],
            author: 'Prath',
            text: 'Just adding a test entry to check the portal rendering!',
            replies: []
        });
        saveDiary();
        renderDiary();
    }

    function renderDiary() {
        const list = document.getElementById('diaryList');
        list.innerHTML = '';

        if (diaryData.length === 0) {
            list.innerHTML = '<p style="text-align:center">No entries yet.</p>';
            return;
        }

        diaryData.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(entry => {
            const el = document.createElement('div');
            el.className = 'diary-entry-list-item';
            
            let repliesHtml = '';
            if(entry.replies && entry.replies.length > 0) {
                repliesHtml = entry.replies.map(r => 
                    `<div class="reply-section"><strong>Response:</strong> ${r.text}</div>`
                ).join('');
            }

            el.innerHTML = `
                <div class="entry-header">
                    <span>üìÖ ${entry.date}</span>
                    <span>‚úçÔ∏è ${entry.author}</span>
                </div>
                <div class="entry-content">${entry.text}</div>
                ${repliesHtml}
                <div style="text-align: right; margin-top: 10px;">
                    <button class="reply-btn" onclick="openReply(${entry.id})">üí¨ Reply</button>
                </div>
            `;
            list.appendChild(el);
        });
    }

    function openReply(id) {
        const text = prompt("Enter your reply message:");
        if (text) {
            const entry = diaryData.find(e => e.id === id);
            if (entry) {
                if (!entry.replies) entry.replies = [];
                entry.replies.push({ text: text, date: new Date().toISOString() });
                saveDiary();
                renderDiary();
            }
        }
    }

    // ===== 3D GRAPHICS UTILS (Canvas 2D) =====
    // Draws a shiny 3D sphere/fruit
    function draw3DFruit(ctx, x, y, radius, type) {
        ctx.save();
        
        // Base Gradient (Shadow to Highlight)
        let grad = ctx.createRadialGradient(x - radius/3, y - radius/3, radius/10, x, y, radius);
        
        if (type === 'watermelon') {
            grad.addColorStop(0, '#ff9999');
            grad.addColorStop(1, '#cc0000');
            ctx.fillStyle = grad;
            ctx.beginPath(); ctx.arc(x, y, radius, 0, Math.PI * 2); ctx.fill();
            
            // Seeds
            ctx.fillStyle = 'rgba(0,0,0,0.8)';
            for(let i=0; i<3; i++) {
                ctx.beginPath();
                ctx.ellipse(x + (i*10)-10, y+5, 3, 6, 0.5, 0, Math.PI*2);
                ctx.fill();
            }
            // Rind
            ctx.strokeStyle = '#2d6a4f';
            ctx.lineWidth = 4;
            ctx.stroke();
        } 
        else if (type === 'orange') {
            grad.addColorStop(0, '#ffd6a5');
            grad.addColorStop(1, '#e85d04');
            ctx.fillStyle = grad;
            ctx.beginPath(); ctx.arc(x, y, radius, 0, Math.PI * 2); ctx.fill();
            
            // Dimples
            ctx.fillStyle = 'rgba(200, 100, 0, 0.3)';
            for(let i=0; i<5; i++) ctx.fillRect(x + Math.random()*20-10, y + Math.random()*20-10, 2, 2);
        }
        else if (type === 'bomb') {
            grad.addColorStop(0, '#4a4e69');
            grad.addColorStop(1, '#22223b');
            ctx.fillStyle = grad;
            ctx.beginPath(); ctx.arc(x, y, radius, 0, Math.PI * 2); ctx.fill();
            
            // Fuse
            ctx.strokeStyle = '#d4a373';
            ctx.lineWidth = 3;
            ctx.beginPath(); ctx.moveTo(x, y-radius); ctx.quadraticCurveTo(x+10, y-radius-10, x+15, y-radius-15); ctx.stroke();
            // Spark
            ctx.fillStyle = '#ffba08';
            ctx.beginPath(); ctx.arc(x+15, y-radius-15, 4, 0, Math.PI*2); ctx.fill();
        }

        // Highlight reflection (Glassy look)
        ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
        ctx.beginPath();
        ctx.ellipse(x - radius/3, y - radius/3, radius/3, radius/5, -0.8, 0, Math.PI*2);
        ctx.fill();
        
        ctx.restore();
    }

    // Draws a shiny 3D Heart
    function draw3DHeart(ctx, x, y, size, color) {
        ctx.save();
        ctx.translate(x, y);
        
        // Shadow
        ctx.shadowColor = "rgba(0,0,0,0.3)";
        ctx.shadowBlur = 10;
        
        // Gradient for 3D effect
        let grad = ctx.createRadialGradient(-size/4, -size/4, 2, 0, 0, size);
        grad.addColorStop(0, '#ffccd5'); // Highlight
        grad.addColorStop(1, color);     // Base
        
        ctx.fillStyle = grad;
        
        // Heart Shape
        ctx.beginPath();
        ctx.moveTo(0, size * 0.3);
        ctx.bezierCurveTo(size / 2, -size / 2, size, 0, 0, size);
        ctx.bezierCurveTo(-size, 0, -size / 2, -size / 2, 0, size * 0.3);
        ctx.fill();
        
        ctx.restore();
    }

    // ===== GAME 1: LOVE SLASHER (3D) =====
    function initSlasher() {
        document.getElementById('slasherOverlay').style.display = 'none';
        const canvas = document.getElementById('slasherCanvas');
        const parent = document.getElementById('slasherContainer');
        
        // Fix Visibility: Set dynamic resolution
        canvas.width = parent.clientWidth;
        canvas.height = parent.clientHeight;
        const ctx = canvas.getContext('2d');
        
        let score = 0;
        let objects = []; // Fruits/Bombs
        let particles = [];
        let trail = [];
        let frame = 0;
        
        document.getElementById('slashScore').textContent = '0';

        // Mouse/Touch Tracking
        function track(e) {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            trail.push({ x: clientX - rect.left, y: clientY - rect.top, life: 8 });
        }
        canvas.addEventListener('mousemove', track);
        canvas.addEventListener('touchmove', track, {passive: false});

        function loop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            frame++;

            // Spawn Logic
            if (frame % 40 === 0) {
                const types = ['watermelon', 'orange', 'watermelon', 'bomb'];
                const type = types[Math.floor(Math.random() * types.length)];
                objects.push({
                    x: Math.random() * (canvas.width - 60) + 30,
                    y: canvas.height + 50,
                    vx: (Math.random() - 0.5) * 5,
                    vy: -(Math.random() * 6 + 10), // Throw up
                    radius: 30,
                    type: type
                });
            }

            // Draw Trail
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 5;
            ctx.lineCap = 'round';
            ctx.beginPath();
            for(let i=0; i<trail.length-1; i++) {
                ctx.moveTo(trail[i].x, trail[i].y);
                ctx.lineTo(trail[i+1].x, trail[i+1].y);
            }
            ctx.stroke();
            // Decay trail
            trail.forEach(t => t.life--);
            trail = trail.filter(t => t.life > 0);

            // Update Objects
            for (let i = objects.length - 1; i >= 0; i--) {
                let obj = objects[i];
                obj.x += obj.vx;
                obj.y += obj.vy;
                obj.vy += 0.25; // Gravity

                draw3DFruit(ctx, obj.x, obj.y, obj.radius, obj.type);

                // Check collision with trail
                let hit = false;
                for(let t of trail) {
                    let dx = t.x - obj.x;
                    let dy = t.y - obj.y;
                    if (Math.sqrt(dx*dx + dy*dy) < obj.radius) {
                        hit = true; break;
                    }
                }

                if (hit) {
                    if (obj.type === 'bomb') {
                        stopGames();
                        alert("BOOM! Game Over.");
                        document.getElementById('slasherOverlay').style.display = 'flex';
                        return;
                    } else {
                        score++;
                        document.getElementById('slashScore').textContent = score;
                        // Add splash particles
                        for(let p=0; p<10; p++) {
                            particles.push({
                                x: obj.x, y: obj.y,
                                vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
                                life: 20, color: obj.type === 'watermelon' ? 'red' : 'orange'
                            });
                        }
                        objects.splice(i, 1);
                        continue;
                    }
                }

                if (obj.y > canvas.height + 60) objects.splice(i, 1);
            }

            // Particles
            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i];
                p.x += p.vx; p.y += p.vy; p.life--;
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, 4, 4);
                if(p.life <= 0) particles.splice(i, 1);
            }

            currentGameLoop = requestAnimationFrame(loop);
        }
        loop();
    }

    // ===== GAME 2: CATCH THE HEART (3D) =====
    function initCatchGame() {
        document.getElementById('catchOverlay').style.display = 'none';
        const canvas = document.getElementById('catchCanvas');
        const parent = document.getElementById('catchContainer');
        
        canvas.width = parent.clientWidth;
        canvas.height = parent.clientHeight;
        const ctx = canvas.getContext('2d');

        let score = 0;
        let hearts = [];
        let basket = { x: canvas.width/2, w: 60, h: 40 };
        let frame = 0;

        document.getElementById('catchScore').textContent = '0';

        // Move Basket
        function moveBasket(e) {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            let clientX = e.touches ? e.touches[0].clientX : e.clientX;
            basket.x = clientX - rect.left - basket.w/2;
        }
        canvas.addEventListener('mousemove', moveBasket);
        canvas.addEventListener('touchmove', moveBasket, {passive: false});

        function loop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            frame++;

            // Draw Basket (Simple 3D box)
            ctx.fillStyle = '#8d99ae';
            ctx.fillRect(basket.x, canvas.height - 50, basket.w, basket.h);
            ctx.fillStyle = '#2b2d42'; // Inner shadow
            ctx.fillRect(basket.x+5, canvas.height - 50, basket.w-10, 5);

            // Spawn Hearts
            if (frame % 30 === 0) {
                hearts.push({
                    x: Math.random() * (canvas.width - 30),
                    y: -30,
                    size: 15 + Math.random() * 10,
                    speed: 2 + Math.random() * 3,
                    color: Math.random() > 0.8 ? '#333' : '#d90429' // Black is bad
                });
            }

            for(let i=hearts.length-1; i>=0; i--) {
                let h = hearts[i];
                h.y += h.speed;

                draw3DHeart(ctx, h.x, h.y, h.size, h.color);

                // Catch Logic
                if (h.y > canvas.height - 50 && h.y < canvas.height && 
                    h.x > basket.x - 20 && h.x < basket.x + basket.w + 20) {
                    
                    if(h.color === '#333') { // Caught bad heart
                        score -= 5;
                    } else {
                        score++;
                    }
                    document.getElementById('catchScore').textContent = score;
                    hearts.splice(i, 1);
                }
                else if (h.y > canvas.height) {
                    hearts.splice(i, 1);
                }
            }

            currentGameLoop = requestAnimationFrame(loop);
        }
        loop();
    }
</script>
</body>
</html>
